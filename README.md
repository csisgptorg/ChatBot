# ChatBot

نمونه اسکلت برای بک‌اند ASP.NET Core با کنترلر، کشف Reflection برای DbSetها و AutoMapper بدون پروفایل‌های جداگانه. این ساختار شامل لایه‌های دامنه، برنامه، پایداری (Persistence)، سرویس‌ها و WebApi مطابق معماری [Csis.Template](https://github.com/MohmmdSjjd/Csis.Template) است و پایه‌ای برای اتصال کلاینت Flutter و لایه ربات تلگرام فراهم می‌کند.


## قابلیت‌های پیاده‌سازی‌شده مطابق سناریو
- قوانین اشتراک (عمومی/برنزی/نقره‌ای/طلایی/VIP) و سقف دانلود/لایک روزانه و دسترسی به دسته‌بندی‌ها.
- جلوگیری از نمایش استوری تکراری برای هر کاربر و ثبت کلیک روی دسته‌بندی‌ها.
- دانلود و لایک فقط در صورت رعایت قوانین (مثلاً لایک پس از دانلود) به‌همراه ایجاد ریمایندر ۲۴ ساعته.
- زمان‌بندی استوری با مقصد دلخواه (دایرکت/ربات/صفحه) و مقصد پشتیبان.
- Entityها و DbSetها به‌صورت Reflection کشف می‌شوند و EF Core (InMemory به صورت پیش‌فرض) به پروژه افزوده شده است.
## نکات کلیدی
- **کنترلرها**: در مسیر `src/WebApi/Controllers` نمونه `StoriesController` قرار دارد و می‌توانید سایر کنترلرها را مشابه اضافه کنید.
- **لایه سرویس‌ها**: پروژه `ChatBot.Services` سرویس‌های مقطعی (مانند زمان سرور، کاربر فعلی و Health Check) را ثبت می‌کند و در WebApi مصرف می‌شود.
- **DbSet با Reflection**: در `AppDbContext` همه Entityهایی که از `BaseEntity` ارث می‌برند به‌صورت خودکار در مدل EF Core ثبت و DbSet آن‌ها در دیکشنری داخلی آماده می‌شود.
- **BaseEntity**: تمام کلاس‌های دامنه از `BaseEntity` مشتق می‌شوند تا شناسه، زمان ایجاد/به‌روزرسانی و حذف منطقی را یکپارچه کنند.
- **AutoMapper بدون پروفایل**: از Attribute اختصاصی `AutoMapAttribute` برای تعریف نگاشت استفاده شده و پیکربندی در زمان اجرا با Reflection انجام می‌شود.

## اجرای API
پروژه نمونه با پایگاه‌داده InMemory تنظیم شده و Health Check روی `/health` فعال است. تنظیمات با الگوی `Csis.Template` از طریق 
بخش‌های تنظیمات زیر قابل کنترل است:

- `DatabaseOptions`: تعیین استفاده از InMemory یا SqlServer، لاگینگ و Pooling.
- `CorsOptions`: لیست مبداهای مجاز برای CORS که در لایه وب اعمال می‌شود.
- `SwaggerOptions`: عنوان/توضیحات و نسخه مستندات Swagger.

برای اجرای محلی:

```bash
cd src/WebApi
dotnet run
```

سپس Swagger روی `https://localhost:5001/swagger` در دسترس خواهد بود. برای استفاده از SQL Server/PostgreSQL تنظیمات `AddDbContext` را در `Program.cs` و مقداردهی ConnectionString تغییر دهید.
